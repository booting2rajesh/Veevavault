<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QMS Object Search</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #fff;
        }
        .logo {
            margin-top: 20px;
        }
        .search-box {
            display: flex;
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
        }
        .search-box input[type="text"] {
            flex: 1;
            padding: 10px 20px;
            font-size: 16px;
            border: 1px solid #dfe1e5;
            border-radius: 24px 0 0 24px;
            outline: none;
        }
        .search-box button {
            padding: 0 20px;
            border: 1px solid #dfe1e5;
            border-left: none;
            background-color: #f8f9fa;
            cursor: pointer;
            border-radius: 0 24px 24px 0;
            font-size: 16px;
        }
        .error-message {
            color: red;
            font-size: 14px;
            margin-top: 10px;
            display: none;
            text-align: center;
        }
        #loadingIndicator {
            margin-top: 20px;
            display: none;
        }
        .loader {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            position: relative;
            animation: rotate 1s linear infinite;
        }
        .loader::before, .loader::after {
            content: "";
            box-sizing: border-box;
            position: absolute;
            inset: 0px;
            border-radius: 50%;
            border: 5px solid #868789;
            animation: prixClipFix 2s linear infinite;
        }
        .loader::after {
            border-color: #f69a1b;
            animation: prixClipFix 2s linear infinite, rotate 0.5s linear infinite reverse;
            inset: 6px;
        }
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes prixClipFix {
            0% { clip-path: polygon(50% 50%, 0 0, 0 0, 0 0, 0 0, 0 0); }
            25% { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 0, 100% 0); }
            50% { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 100%, 100% 100%, 100% 100%); }
            75% { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 100%, 0 100%, 0 100%); }
            100% { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 100%, 0 100%, 0 0); }
        }
        table {
            width: 96%;
            
            border-collapse: separate;
            border-spacing: 0;
			 max-width: 1300px;
    table-layout: fixed; /* This will enforce fixed layout */
            margin-top: 6px;
            display: none; /* Initially hidden */
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); /* Shadow effect */
        }
	
        th, td {
		 
		  border-right: 1px solid #ffffff; 
            padding: 12px 15px;
            text-align: center;
 word-wrap: break-word; /* Allows long words to break onto the next line */
    overflow: hidden; /* Prevents overflow of content */
    white-space: normal; /* Ensures text can wrap */
                    
		  border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f69a1b;
            font-weight: bold;
            color: white; 
            font-size: 18px;
            font-family: 'Georgia', serif;
            letter-spacing: 0.5px;
        }

        /* Alternate row colors */
        tbody tr:nth-child(even) {
            background-color: #cfcccc; /* Light grey for even rows */
            font-family: 'Georgia', serif;
            letter-spacing: 0.5px;
 font-size: 18px;
           
 }

        tbody tr:nth-child(odd) {
            background-color: #ffffff; /* White for odd rows */
            font-family: 'Georgia', serif;
 font-size: 18px;
                    
		  letter-spacing: 0.5px;
        }

        /* Optional: Remove bottom border from last row to create a cleaner look */
        tr:last-child td {
            border-bottom: none;
			 border-right: none; 
        }

        /* Summary Section */
        .summary-section {
            display: flex;
            width: 100%;
            max-width: 600px;
            font-size: 17px;
            
           
            
			text-align: left;
        }
        .summary-section h2 {
            font-family: 'Georgia', serif;
            color: #333;
            
            letter-spacing: 0.5px;
			margin-bottom: 10px;
			}
        .summary-buttons button {
            width: 600px;
			 margin-top: 1px;    /* Increased top margin */
    margin-bottom: 1px; /* Increased bottom margin */
            font-size: 18px;
            padding: 10px 20px;
            
            border: none;
            background-color: #f69a1b; /* Orange color */
            color: white;
            border-radius: 5px;
            cursor: default; /* No pointer */
            font-family: 'Georgia', serif;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>

    <div class="logo">
        <img src="vault.png" alt="Logo" width="222" height="68">
    </div>

    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search...">
        <button id="searchButton">Search</button>
    </div>

    <!-- Summary Section -->
    <div class="summary-section" id="summarySection" style="display: none;">
        <h2>Summary:</h2>
        <div class="summary-buttons">
            <button id="totalObjectsButton">
                Total Number of Objects in Quality Vault: 0
            </button>
            <button id="systemObjectsButton">
                System Objects: 0
            </button>
            <button id="standardVaultObjectsButton">
                Standard Vault Objects: 0
            </button>
            <button id="applicationSpecificObjectsButton">
                Application Specific Objects: 0
            </button>
            <button id="customObjectsButton">
                Custom Objects: 0
            </button>
        </div>
    </div>

    <div class="error-message" id="errorMessage">
        This Search will fetch object model of "QMS" Vault Only.
    </div>

    <!-- Loading Indicator with Spinner -->
    <div id="loadingIndicator" style="display: none;">
        <div class="loader"></div>
    </div>

    <!-- Results Table -->
    <table id="resultsTable">
        <thead>
            <tr>
                <th>System Objects</th>
                <th>Standard Vault Objects</th>
                <th>Application Specific Objects</th>
                <th>Custom Objects</th>
            </tr>
        </thead>
        <tbody id="resultsBody">
            <!-- Rows will be populated here -->
        </tbody>
    </table>

    <script>
        // Debounce Function
        function debounce(func, delay) {
            let debounceTimer;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(context, args), delay);
            }
        }

        // Attach Debounced Input Event
        document.getElementById("searchInput").addEventListener("input", debounce(function() {
            const input = this.value.trim().toUpperCase();
            const errorMessage = document.getElementById("errorMessage");

            if (input === "QMS") {
                errorMessage.style.display = "none"; // Hide error message if "QMS" is typed
            } else {
                errorMessage.style.display = "block"; // Show error message for any other input
            }
        }, 300));

        // Attach Keydown Event Listener for Enter Key
        document.getElementById("searchInput").addEventListener("keydown", (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent the default form submission
                document.getElementById("searchButton").click(); // Trigger the search button click
            }
        });

        // Attach Click Event Listener
        document.getElementById("searchButton").addEventListener("click", async () => {
            await validateInput();
        });

        // Asynchronous Validate Input Function
        async function validateInput() {
            const input = document.getElementById("searchInput").value.trim().toUpperCase();
            const errorMessage = document.getElementById("errorMessage");

            if (input === "QMS") {
                errorMessage.style.display = "none"; // Hide error message
                await fetchMetadata(); // Fetch metadata for "QMS"
            } else {
                errorMessage.style.display = "block"; // Show error message
            }
        }

        async function fetchMetadata() {
            const username = 'prana.user4@partnersi-prana4life.com'; 
            const password = 'Prana4@2025!'; 

            const formData = new URLSearchParams();
            formData.append('username', username);
            formData.append('password', password);

            // Show loading indicator
            document.getElementById("loadingIndicator").style.display = "block";

            try {
                // Authenticate and get sessionId
                const authResponse = await fetch('https://cors-anywhere.herokuapp.com/https://partnersi-prana4life-quality.veevavault.com/api/v24.2/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest' // Added header
                    },
                    body: formData
                });

                if (!authResponse.ok) {
                    throw new Error(`Authentication failed with status ${authResponse.status}`);
                }

                const authData = await authResponse.json();
                console.log('Auth Response Data:', authData);
                const sessionId = authData.sessionId;

                // Check if sessionId was returned
                if (!sessionId) {
                    throw new Error('Failed to obtain session ID.');
                }

                // Fetch metadata using the sessionId
                const metadataResponse = await fetch('https://cors-anywhere.herokuapp.com/https://partnersi-prana4life-quality.veevavault.com/api/v24.2/metadata/vobjects', {
                    method: 'GET',
                    headers: {
                        'Authorization': sessionId,
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest' // Added header
                    }
                });

                if (!metadataResponse.ok) {
                    throw new Error(`Metadata fetch failed with status ${metadataResponse.status}`);
                }

                const metadataData = await metadataResponse.json();
                console.log('Metadata Data:', metadataData);

                // Check if the response structure matches expectations
                if (!metadataData || !metadataData.objects) {
                    throw new Error('Invalid metadata response structure.');
                }

                // Categorize objects based on suffix
                const systemObjects = metadataData.objects.filter(obj => obj.name.endsWith('__sys'));
                const standardVaultObjects = metadataData.objects.filter(obj => obj.name.endsWith('__v'));
                const applicationSpecificObjects = metadataData.objects.filter(obj => obj.name.endsWith('__qdm'));
                const customObjects = metadataData.objects.filter(obj => obj.name.endsWith('__c'));

                // Display the results in the table
                displayResults(systemObjects, standardVaultObjects, applicationSpecificObjects, customObjects);

                // Update summary buttons
                updateSummaryButtons(systemObjects.length, standardVaultObjects.length, applicationSpecificObjects.length, customObjects.length);

            } catch (error) {
                console.error('Error fetching metadata:', error);
                // Optionally, display the error message to the user
                document.getElementById("errorMessage").innerText = `Error: ${error.message}`;
                document.getElementById("errorMessage").style.display = "block";
            } finally {
                // Hide loading indicator
                document.getElementById("loadingIndicator").style.display = "none";
            }
        }

        function displayResults(systemObjects, standardVaultObjects, applicationSpecificObjects, customObjects) {
            const table = document.getElementById("resultsTable");
            const tbody = document.getElementById("resultsBody");

            tbody.innerHTML = ''; // Clear any previous content

            // Determine the maximum number of rows needed
            const maxRows = Math.max(systemObjects.length, standardVaultObjects.length, applicationSpecificObjects.length, customObjects.length);

            for (let i = 0; i < maxRows; i++) {
                const row = document.createElement("tr");

                // System Objects
                const sysCell = document.createElement("td");
                sysCell.textContent = systemObjects[i] ? systemObjects[i].name : '';
                row.appendChild(sysCell);

                // Standard Vault Objects
                const stdCell = document.createElement("td");
                stdCell.textContent = standardVaultObjects[i] ? standardVaultObjects[i].name : '';
                row.appendChild(stdCell);

                // Application Specific Objects
                const appCell = document.createElement("td");
                appCell.textContent = applicationSpecificObjects[i] ? applicationSpecificObjects[i].name : '';
                row.appendChild(appCell);

                // Custom Objects
                const custCell = document.createElement("td");
                custCell.textContent = customObjects[i] ? customObjects[i].name : '';
                row.appendChild(custCell);

                tbody.appendChild(row);
            }

            // Show the table if there are any results
            const hasResults = systemObjects.length > 0 || standardVaultObjects.length > 0 || applicationSpecificObjects.length > 0 || customObjects.length > 0;
            table.style.display = hasResults ? 'table' : 'none';
        }

        function updateSummaryButtons(systemCount, standardVaultCount, applicationSpecificCount, customCount) {
            const totalCount = systemCount + standardVaultCount + applicationSpecificCount + customCount;

            // Show the summary section
            const summarySection = document.getElementById("summarySection");
            summarySection.style.display = 'block';

            // Update Total Objects Button
            const totalObjectsButton = document.getElementById("totalObjectsButton");
            totalObjectsButton.textContent = `Total Number of Objects in Quality Vault: ${totalCount}`;

            // Update System Objects Button
            const systemObjectsButton = document.getElementById("systemObjectsButton");
            systemObjectsButton.textContent = `System Objects: ${systemCount}`;

            // Update Standard Vault Objects Button
            const standardVaultObjectsButton = document.getElementById("standardVaultObjectsButton");
            standardVaultObjectsButton.textContent = `Standard Vault Objects: ${standardVaultCount}`;

            // Update Application Specific Objects Button
            const applicationSpecificObjectsButton = document.getElementById("applicationSpecificObjectsButton");
            applicationSpecificObjectsButton.textContent = `Application Specific Objects: ${applicationSpecificCount}`;

            // Update Custom Objects Button
            const customObjectsButton = document.getElementById("customObjectsButton");
            customObjectsButton.textContent = `Custom Objects: ${customCount}`;
        }
    </script>

</body>
</html>
