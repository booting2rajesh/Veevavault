<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QMS Object Search</title>
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,600" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
    <style>
        /* Basic reset and body styling */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Source Sans Pro', sans-serif;
            background-color: #fefefe;
        }

        /* Landing Page Centered Style */
        .landing-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }

        .landing-logo img {
            width: 200px;
        }

        .landing-search-box {
            display: flex;
            align-items: center;
            margin-top: 30px;
        }

        .landing-search-box input[type="text"] {
            width: 600px;
            padding: 15px 20px;
            font-size: 1.2em;
            border: 1px solid #dfe1e5;
            border-radius: 24px 0 0 24px;
            outline: none;
        }

        .landing-search-box button {
            padding: 15px 20px;
            border: 1px solid #dfe1e5;
            border-left: none;
            background-color: #f8f9fa;
            cursor: pointer;
            border-radius: 0 24px 24px 0;
            font-size: 1.2em;
            transition: background-color 0.3s;
        }

        .landing-search-box button:hover {
            background-color: #e0e0e0;
        }

        /* Search Results Page Layout */
        .search-results {
            display: none;
            padding: 20px;
        }

        .top-bar {
            display: flex;
            align-items: center;
            margin-left: 20px;
        }

        .top-bar-logo img {
            width: 80px;
        }

        .top-bar-search-box {
            display: flex;
            align-items: center;
            margin-left: 20px;
        }

        .top-bar-search-box input[type="text"] {
            width: 450px;
            padding: 10px 20px;
            font-size: 1em;
            border: 1px solid #dfe1e5;
            border-radius: 24px 0 0 24px;
            outline: none;
        }

        .top-bar-search-box button {
            padding: 10px 20px;
            border: 1px solid #dfe1e5;
            border-left: none;
            background-color: #f8f9fa;
            cursor: pointer;
            border-radius: 0 24px 24px 0;
            font-size: 1em;
            transition: background-color 0.3s;
        }

        .filter-tabs {
            display: flex;
            justify-content: left;
            margin-left: 120px;
            margin-top: 20px;
        }

        .filter-tabs a {
            padding: 10px 15px;
            margin: 0 5px;
            color: #333;
            font-size: 1em;
            border-bottom: 2px solid transparent;
            text-decoration: none;
            cursor: pointer;
        }

        .filter-tabs a.active {
            border-bottom: 2px solid #fc9918;
        }

        .filter-divider {
            margin: 10px 0;
            border: 0;
            border-top: 1px solid #ccc;
            width: 100vw;
            position: relative;
            left: 50%;
            right: 50%;
            margin-left: -50vw;
        }

        .results-section {
            margin-top: 20px;
            padding: 20px;
        }

        .results-section h3 {
            color: #555;
            font-size: 1.2em;
        }

        .result-item {
            margin-bottom: 20px;
            padding: 15px;
            border-bottom: 1px solid #dfe1e5;
			line-height: 29px;
			font-size: 20px;
        }

        .result-item h4 {
            color: #333;
            font-size: 1.1em;
        }

        .result-item p {
            color: #666;
            font-size: 0.9em;
        }

        /* Add styles for debugging */
        #jsonDisplay {
            width: 100%;
            height: 50px;
            margin-top: 20px;
            font-size: 12px;
            display: none; /* Hide initially */
        }


   .view-document-button {
            background-color: #007bff; /* Button color */
            color: white; /* Text color */
            border: none; /* Remove border */
            padding: 10px 20px; /* Padding */
            border-radius: 5px; /* Rounded corners */
            cursor: pointer; /* Pointer cursor */
			margin-top:10px;
        }

        .view-document-button:hover {
            background-color: #0056b3; /* Darker shade on hover */
        }

        
        /* Example styles for results container */
        #searchResultsContainer {
            margin: 20px; /* Adds some margin for spacing */
        }


        #errorMessage {
            color: red;
            display: none;
            margin-top: 10px;
        }
		
			.loader {
    width: 40px;
    height: 40px;
    --c: no-repeat linear-gradient(orange 0 0);
    background: var(--c), var(--c), var(--c), var(--c);
    background-size: 21px 21px;
    animation: l5 1.5s infinite cubic-bezier(0.3, 1, 0, 1);
    position: fixed;       /* Fix position to keep it centered */
    top: 50%;              /* Center vertically */
    left: 50%;             /* Center horizontally */
    transform: translate(-50%, -50%); /* Offset by half width and height to center */
    display: none; /* Hide by default */
    z-index: 1000; /* Ensure it appears on top of other elements */
}

.loader-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background: rgba(255, 255, 255, 0.8); /* Optional background overlay */
    z-index: 1000;
}

        .show-loader {
            display: block; /* Show loader when class added */
        }

        @keyframes l5 {
            0% { background-position: 0 0, 100% 0, 100% 100%, 0 100% }
            33% { background-position: 0 0, 100% 0, 100% 100%, 0 100%; width:60px; height: 60px }
            66% { background-position: 100% 0, 100% 100%, 0 100%, 0 0; width:60px; height: 60px }
            100% { background-position: 100% 0, 100% 100%, 0 100%, 0 0 }
        }
		
		
    </style>
</head>
<body>

 <div class="loader"></div>
 
 <div id="content">
    <!-- Landing Page -->
    <div class="landing-page" id="landingPage">
        <div class="landing-logo">
            <img src="vault.png" alt="Logo">
        </div>
        <div class="landing-search-box">
            <input type="text" id="landingSearchInput" placeholder="Search...">
            <button onclick="startSearch()">Search</button>
			
        </div>
    </div>

    <!-- Search Results Page -->
    <div class="search-results" id="searchResultsPage">
        <div class="top-bar">
            <div class="top-bar-logo">
                <img src="vault.png" alt="Logo">
            </div>
			
			
            <div class="top-bar-search-box">
                <input type="text" id="topSearchInput" placeholder="Search...">
                <button id="searchButton" onclick="handleSearch()">Search</button>
            </div>
        </div>
		


        <!-- Filter Tabs -->
    
		
		<div class="filter-tabs">
    <a class="active" id="allTab" onclick="filterResults('all')">All</a>
    <a id="nameTab" onclick="filterResults('name')">Name</a>
    <a id="fileNameTab" onclick="filterResults('fileName')">File Name</a>
    <a id="lifecycleTab" onclick="filterResults('lifecycle')">Life Cycle</a>
    <a id="docTypeTab" onclick="filterResults('docType')">Type</a>
    <a id="docSubTypeTab" onclick="filterResults('docSubType')">Sub Type</a>
    <a id="docClassifyTab" onclick="filterResults('docClassify')">Classification</a>
</div>


		
		
		
		
        <hr class="filter-divider">

        <!-- 
        <div class="results-section" id="resultsSection">
          
           <textarea id="jsonDisplay" readonly></textarea>
            <p id="errorMessage"></p>
        </div>-->
		
		<!-- Add this to your HTML where you want to display the search results -->
<div id="searchResultsContainer"></div>  

		
    </div>
<!-- <div id="resultsSection"></div>  -->


<script>


// Show loader


 function showLoader() {
            document.querySelector('.loader').classList.add('show-loader');
        }

        // Hide loader
        function hideLoader() {
            document.querySelector('.loader').classList.remove('show-loader');
        }

function startSearch() {
    const searchInput = document.getElementById('landingSearchInput').value;
    if (searchInput.trim() === '') {
        alert('Please enter a search term');
        return;
    }

    document.getElementById('landingPage').style.display = 'none';
    document.getElementById('searchResultsPage').style.display = 'block';
    document.getElementById('topSearchInput').value = searchInput;

    handleSearch();
}

async function handleSearch() {
    const searchTerm = document.getElementById('topSearchInput').value;
    if (searchTerm.trim() === '') {
        alert('Please enter a search term');
        return;
    }
 showLoader();
    // Perform search and fetch data from Veeva server
    await fetchMetadata(searchTerm);
}


 
 
// Add event listeners for Enter key on both search inputs
document.getElementById('landingSearchInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        startSearch();
    }
});

document.getElementById('topSearchInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        handleSearch();
    }
});

// Track the current filter type
let activeFilter = 'all'; // Default to 'all'
let metadataData = null; // To store fetched metadata globally

async function fetchMetadata(searchTerm) {
    const username = 'prana.user4@partnersi-prana4life.com'; 
    const password = 'Prana4@2025!'; // Avoid hardcoding credentials in production

    const formData = new URLSearchParams();
    formData.append('username', username);
    formData.append('password', password);


    try {
        // Authentication request
        const authResponse = await fetch('https://cors-anywhere.herokuapp.com/https://partnersi-prana4life-quality.veevavault.com/api/v24.2/auth', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });

        if (!authResponse.ok) {
            throw new Error(`Authentication failed: ${authResponse.status}`);
        }

        const authData = await authResponse.json();
        const sessionId = authData.sessionId;

        if (!sessionId) {
            throw new Error('Failed to obtain session ID.');
        }

        // Search query
        const query = buildQuery(searchTerm);
        const searchResponse = await fetch(`https://cors-anywhere.herokuapp.com/https://partnersi-prana4life-quality.veevavault.com/api/v24.2/query?q=${query}`, { 
            headers: {
                'Authorization': sessionId,
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        if (!searchResponse.ok) {
            throw new Error(`Search failed: ${searchResponse.status}`);
        }

        metadataData = await searchResponse.json(); // Store metadata globally

        // Display the response in the JSON textarea for debugging
       // document.getElementById('jsonDisplay').style.display = 'block';
        // document.getElementById('jsonDisplay').value = JSON.stringify(metadataData, null, 2);

        // Call function to display results
        displayFilteredResults(metadataData, searchTerm);

    } catch (error) {
        console.error('Error during fetch:', error);
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('errorMessage').textContent = `Error fetching metadata: ${error.message}`;
    }
	finally {
        hideLoader(); // Hide the loader once fetch is complete (success or failure)
    }
}

// Handle tab changes and filter results locally based on the filter type
function filterResults(type) {
    // Update the active filter
    activeFilter = type;

    // Update UI tab states
    const tabs = document.querySelectorAll('.filter-tabs a');
    tabs.forEach(tab => tab.classList.remove('active'));
    document.getElementById(type + 'Tab').classList.add('active');

    // Display filtered results based on the selected filter
    if (metadataData) {
        displayFilteredResults(metadataData);
    }
}

// Function to display the filtered results on the UI
function displayFilteredResults(metadataData) {
    const resultsContainer = document.getElementById('searchResultsContainer');
    resultsContainer.innerHTML = ''; // Clear previous results

    const results = metadataData.data; // Assuming the results are in a 'data' field

    if (!results || results.length === 0) {
        resultsContainer.innerHTML = `<p>No results found.</p>`;
        return;
    }

    results.forEach(result => {
        const resultDiv = document.createElement('div');
        resultDiv.classList.add('result-item');

        // Conditionally display fields based on the active filter
        if (activeFilter === 'all' || activeFilter === 'name') {
            resultDiv.innerHTML += `<p><strong>Name:</strong> ${result.name__v || 'N/A'}</p>`;
        }
        if (activeFilter === 'all' || activeFilter === 'fileName') {
            resultDiv.innerHTML += `<p><strong>Filename:</strong> ${result.filename__v || 'N/A'}</p>`;
        }
        if (activeFilter === 'all' || activeFilter === 'lifecycle') {
            resultDiv.innerHTML += `<p><strong>Lifecycle:</strong> ${result.lifecycle__v || 'N/A'}</p>`;
        }
        if (activeFilter === 'all' || activeFilter === 'docType') {
            resultDiv.innerHTML += `<p><strong>Type:</strong> ${result.type__v || 'N/A'}</p>`;
        }
        if (activeFilter === 'all' || activeFilter === 'docSubType') {
            resultDiv.innerHTML += `<p><strong>Subtype:</strong> ${result.subtype__v || 'N/A'}</p>`;
        }
        if (activeFilter === 'all' || activeFilter === 'docClassify') {
            resultDiv.innerHTML += `<p><strong>Classification:</strong> ${result.classification__v || 'N/A'}</p>`;
        }

        // Construct the document URL
        const docId = result.id; // Extract the document ID
        const documentUrl = `https://partnersi-prana4life-quality.veevavault.com/ui/#doc_info/${docId}/1/0`;

        // Create a button to view the document
        const viewButton = document.createElement('button');
        viewButton.textContent = 'View Document'; // Button label
        viewButton.classList.add('view-document-button'); // Optional: Add a class for styling
        viewButton.onclick = function() {
            window.open(documentUrl, '_blank'); // Open the document in a new tab
        };

        // Append the view button
        const buttonContainer = document.createElement('div');
        buttonContainer.classList.add('button-container'); // Add a container for button alignment
        buttonContainer.appendChild(viewButton);
        resultDiv.appendChild(buttonContainer);
        
        resultsContainer.appendChild(resultDiv);
    });
}

// Build the query (without the need for dynamic filtering during the fetch)
function buildQuery(searchTerm) {
    return `select id, name__v, filename__v, document_number__v, lifecycle__v, type__v, subtype__v, classification__v FROM ALLVERSIONS documents FIND('${searchTerm}' SCOPE ALL)`;
}

</script>

  
  
  
</body>
</html>
